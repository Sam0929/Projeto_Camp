{% extends "base.html" %}

{% block title %}Tabela de Jogos e Pontuação{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Título do Campeonato -->
    <h1 class="text-center" style="color: #160840; text-shadow: 2px 1px 1px #87ceeb;">Tabela de Pontuação - {{ campeonato.nome }}</h1>

    <!-- Exibição da tabela de pontuação -->
    <h2 class="text-center mt-4" style="color: #160840;">Tabela de Pontuação</h2>
    <table class="table table-striped table-bordered mt-3">
        <thead style="background-color: #1E3A8A; color: #FFFFFF;">
            <tr>
                <th>Time</th>
                <th>Pontos</th>
                <th>Vitórias</th>
                <th>Empates</th>
                <th>Derrotas</th>
            </tr>
        </thead>
        <tbody>
            {% for equipe, stats in pontuacao.items %}
            <tr>
                <td>{{ equipe }}</td>
                <td>{{ stats.pontos|default:"0" }}</td>
                <td>{{ stats.vitorias|default:"0" }}</td>
                <td>{{ stats.empates|default:"0" }}</td>
                <td>{{ stats.derrotas|default:"0" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Exibição dos participantes por equipe -->
    <h2 class="text-center mt-5" style="color: #160840;">Equipes Participantes</h2>
    <div class="row">
        {% for equipe, participantes in equipes_participantes.items %}
        <div class="col-md-4">
            <div class="card mb-4" style="background-color: #f0faf9; border: 1px solid #191970;">
                <div class="card-body">
                    <h5 class="card-title">{{ equipe }}</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalEquipe{{ forloop.counter }}">
                        Visualizar Participantes
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal para cada equipe -->
        <div class="modal fade" id="modalEquipe{{ forloop.counter }}" tabindex="-1" aria-labelledby="modalLabel{{ forloop.counter }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #1E3A8A; color: #FFFFFF;">
                        <h5 class="modal-title" id="modalLabel{{ forloop.counter }}">Participantes da equipe {{ equipe }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul class="list-group">
                            {% for participante in participantes %}
                                <li class="list-group-item">{{ participante.nome }}</li>
                            {% empty %}
                                <li class="list-group-item">Nenhum participante cadastrado.</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Botões centrais para visualização de tabela e geração de classificação -->
    <div class="text-center mt-4 d-flex justify-content-center gap-3">
        <button id="toggleTabelaJogos" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#tabelaJogos" aria-expanded="false" aria-controls="tabelaJogos" style="width: 200px;">
            Visualizar Tabela de Jogos
        </button>

        {% if campeonato.classificacao_gerada %}
            <a href="{% url 'visualizar_classificacao' campeonato.id %}" class="btn btn-secondary" style="width: 200px;">Visualizar Classificação</a>
        {% else %}
            {% if user.is_authenticated and user.is_superuser %}
                <a href="{% url 'confirmar_classificacao' campeonato.id %}" class="btn btn-secondary" style="width: 200px;">Gerar Classificação</a>
            {% else %}
                <button class="btn btn-warning" style="width: 200px;" id="btnVisualizarClassificacao">Visualizar Classificação</button>
            {% endif %}
        {% endif %}
    </div>

    <!-- Seção de Jogos por Rodada -->
    <div class="collapse mt-3" id="tabelaJogos">
        {% for rodada in campeonato.rodadas.all %}
        <h3 class="mt-4" style="color: #160820; text-shadow: 2px 1px 1px #87ceeb; background-color: #f0faf9; border: 1px solid #191970; border-radius: 5px;">
            Rodada {{ rodada.numero }} - {{ rodada.data|date:"d/m/Y" }}
        </h3>
        <ul class="list-group mb-1">
            {% for jogo in rodada.jogos.all %}
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {{ jogo.time_casa.equipe }} vs {{ jogo.time_fora.equipe }}
                        <small>({{ jogo.data_horario|date:"d/m/Y H:i" }})</small>
                    </div>
                    <div>
                        {% if jogo.resultado_jogo and jogo.resultado_jogo.gols_time_casa is not None and jogo.resultado_jogo.gols_time_fora is not None %}
                        <span class="badge bg-success rounded-pill">Resultado: {{ jogo.resultado_jogo.gols_time_casa }} - {{ jogo.resultado_jogo.gols_time_fora }}</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">Resultado: Não disponível</span>
                        {% endif %}
                    </div>
                    <!-- Ícone de Chat -->
                    <button 
                        class="btn btn-link text-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#chatModal" 
                        onclick="abrirChat({{ jogo.id }}, '{{ jogo.time_casa.equipe }}', '{{ jogo.time_fora.equipe }}')"
                    >
                        <i class="bi bi-chat-dots"></i>
                    </button>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endfor %}
    </div>

    <!-- Modal para comentários -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Cabeçalho do Modal -->
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="chatModalLabel">Chat do Jogo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Corpo do Modal -->
                <div class="modal-body">
                    <!-- Lista de Comentários -->
                    <div id="comentariosContainer" class="mb-4" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted text-center">Carregando comentários...</p>
                    </div>

                    <!-- Formulário para Adicionar Comentário -->
                    {% if user.is_authenticated %}
                    <form id="comentarioForm" onsubmit="enviarComentario(event)">
                        {% csrf_token %}
                        <input type="hidden" id="jogoIdInput" name="jogo_id">
                        <div class="mb-3">
                            <label for="comentarioTexto" class="form-label fw-bold">Adicionar Comentário</label>
                            <textarea id="comentarioTexto" name="comentario" class="form-control" rows="3" placeholder="Digite seu comentário aqui..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Enviar</button>
                    </form>
                    {% else %}
                    <p class="text-muted text-center">Faça login para adicionar comentários.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


</div>

    <!-- JavaScript para alterar o texto e estilo do botão -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const classificacaoGerada = {{ campeonato.classificacao_gerada|yesno:"true,false" }};
        const btnVisualizar = document.getElementById('btnVisualizarClassificacao');
        if (!classificacaoGerada) {
            btnVisualizar.addEventListener('click', function (event) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('alertModal'));
                modal.show();
            });
        }
    });
</script>

<script>
    function abrirChat(jogoId, timeCasa, timeFora) {
        // Define o título do modal
        const modalLabel = document.getElementById('chatModalLabel');
        modalLabel.textContent = `Chat do Jogo: ${timeCasa} vs ${timeFora}`;

        // Define o ID do jogo no formulário
        const jogoIdInput = document.getElementById('jogoIdInput');
        jogoIdInput.value = jogoId;

        // Limpa os comentários e carrega do servidor
        const comentariosContainer = document.getElementById('comentariosContainer');
        comentariosContainer.innerHTML = '<p class="text-muted">Carregando comentários...</p>';

        fetch(`/gerenciamento/obter_comentarios/${jogoId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const comentariosHtml = data.comentarios.map(comentario => `
                        <div class="list-group-item">
                            <strong>${comentario.usuario}</strong>: ${comentario.texto}
                            <small class="text-muted d-block">${comentario.data_criacao}</small>
                        </div>
                    `).join('');
                    comentariosContainer.innerHTML = comentariosHtml || '<p class="text-muted">Nenhum comentário ainda.</p>';
                } else {
                    comentariosContainer.innerHTML = '<p class="text-danger">Erro ao carregar os comentários.</p>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar comentários:', error);
                comentariosContainer.innerHTML = '<p class="text-danger">Erro ao carregar os comentários.</p>';
            });
    }

    function enviarComentario(event) {
        event.preventDefault();

        const jogoId = document.getElementById('jogoIdInput').value;
        const texto = document.getElementById('comentarioTexto').value.trim();
        const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;

        if (!texto) {
            alert('O comentário não pode estar vazio.');
            return;
        }

        fetch(`/gerenciamento/adicionar_comentario/${jogoId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ comentario: texto }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Comentário adicionado com sucesso!');
                abrirChat(jogoId); // Recarrega os comentários
                document.getElementById('comentarioForm').reset();
            } else {
                alert(data.message || 'Erro ao adicionar o comentário.');
            }
        })
        .catch(error => {
            console.error('Erro ao adicionar comentário:', error);
            alert('Erro ao adicionar o comentário.');
        });
    }
</script>


{% endblock %}
